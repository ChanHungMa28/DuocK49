<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TT Hóa sinh – Full 18 đề (144 câu) – Đảo đáp án</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e9efff; --muted:#9fb0d0; --line:rgba(255,255,255,.12);
      --shadow:0 12px 34px rgba(0,0,0,.35);
      --ok:#22c55e; --bad:#ef4444; --accent:#78a6ff; --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; min-height:100vh; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(120,166,255,.15), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.12), transparent 50%),
        radial-gradient(900px 600px at 60% 100%, rgba(245,158,11,.10), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:0 auto}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin-bottom:14px;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35;max-width:720px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.22);
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
      white-space:nowrap;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button:active{transform:translateY(1px)}
    button.primary{background:rgba(120,166,255,.14);border-color:rgba(120,166,255,.35)}
    button.danger{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35)}
    .score{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .pill.ok{border-color:rgba(34,197,94,.45);color:rgba(34,197,94,.95);background:rgba(34,197,94,.10)}
    .pill.bad{border-color:rgba(239,68,68,.45);color:rgba(239,68,68,.95);background:rgba(239,68,68,.10)}

    .exam{
      margin-top:14px;
      padding:14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
    }
    .examHead{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding-bottom:10px; border-bottom:1px dashed rgba(255,255,255,.12);
      margin-bottom:10px;
    }
    .examTitle{margin:0;font-size:16px}
    .examHint{color:var(--muted);font-size:12px}

    .grid{display:grid;gap:12px;margin-top:10px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:0 10px 24px rgba(0,0,0,.28);
      padding:14px 14px 12px;
    }
    .qhead{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;margin-bottom:10px}
    .qtitle{margin:0;font-size:14px;line-height:1.45}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);border-radius:999px;
      padding:4px 10px;background:rgba(255,255,255,.04);white-space:nowrap;
    }
    .options{display:grid;gap:8px}
    .opt{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px;border:1px solid var(--line);border-radius:12px;
      background:rgba(0,0,0,.10);cursor:pointer;user-select:none;
      transition: background .15s ease, border-color .15s ease, transform .06s ease;
    }
    .opt:hover{background:rgba(255,255,255,.06)}
    .opt:active{transform:translateY(1px)}
    .opt input{margin-top:2px}
    .opt.correct{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.14)}
    .opt.wrong{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.14)}
    .opt.disabled{cursor:not-allowed;opacity:.95}
    .hint{
      margin-top:10px;font-size:12px;color:var(--muted);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      border-top:1px dashed rgba(255,255,255,.10);padding-top:10px;
    }
    .shortRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"]{
      flex:1 1 280px;min-width:220px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.16);color:var(--text);outline:none;
    }
    input[type="text"]:focus{
      border-color:rgba(120,166,255,.45);
      box-shadow:0 0 0 3px rgba(120,166,255,.15);
    }
    .footerNote{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>TT Hóa sinh – Full 18 đề (144 câu)</h1>
      <div class="sub">
        Trắc nghiệm: chọn xong chấm ngay (đúng xanh, sai đỏ). Tự luận: nhập đáp án rồi chấm (Enter để chấm).
        Mỗi lần vào lại trang hoặc bấm “Làm lại” sẽ đảo thứ tự câu trong từng đề và đảo đáp án.
      </div>
      <div class="score" id="scoreBar"></div>
    </div>
    <div class="toolbar">
      <button class="primary" id="btnCheckAll">Chấm tất cả</button>
      <button id="btnReset">Làm lại (đảo đáp án)</button>
      <button class="danger" id="btnClear">Xóa lựa chọn</button>
    </div>
  </header>

  <div id="root"></div>

  <div class="footerNote">
    Nếu bạn muốn “ẩn highlight đáp án đúng khi chọn sai” hoặc “chỉ hiện 1 đề mỗi lần”, nói mình chỉnh.
  </div>
</div>

<script>
/* =========================
   TIỆN ÍCH RNG + SHUFFLE
   ========================= */
function mulberry32(seed){return function(){let t=seed+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;};}
function shuffle(arr,rnd){const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function esc(s){return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");}
function norm(s){
  return (s??"")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/\s+/g," ")
    .replaceAll("–","-")
    .replaceAll("−","-");
}

/* =========================
   3 TEMPLATE ĐỀ (theo đúng nội dung bạn gửi)
   - Template A: Đề 1/4/7/10/13/16
   - Template B: Đề 2/5/8/11/14/17
   - Template C: Đề 3/6/9/12/15/18
   ========================= */
function templateA(){
  return [
    { type:"mcq", q:"Lấy nước tiểu để làm cặn lắng nên lấy:", options:["Nước tiểu 24 giờ","Nước tiểu trong ngày","Nước tiểu vào sáng sớm lúc ngủ dậy","Nước tiểu lúc bất kỳ khi cần xét nghiệm"], correctIndex:2 },
    { type:"mcq", q:"Nước tiểu làm xét nghiệm cặn lắng, cần tranh thủ thời gian khi lấy là:", options:["Dưới 2 giờ","Từ 2 – 3 giờ","Từ 3 - 4 giờ","Từ 4 – 5 giờ"], correctIndex:0 },
    { type:"mcq", q:"Phản ứng Ninhydrin dùng để nhận biết:", options:["Lipid","Glucid","Protid","Cả 3 loại hợp chất trên"], correctIndex:2 },
    { type:"mcq", q:"Môi trường để phản ứng Biuret xảy ra có chứa:", options:["NaOH","HCl","NaCl","H2O"], correctIndex:0 },
    { type:"mcq", q:"Lipid có thể hòa tan được trong:", options:["Dung môi phân cực","Dung môi không phân cực","Dung dịch đệm","Nước"], correctIndex:1 },
    { type:"mcq", q:"Những bệnh sau đây có thể có ceton trong nước tiểu, NGOẠI TRỪ:", options:["Tiểu đường","Rối loạn chuyển hóa","Cushing","Hội chứng thận hư"], correctIndex:3 },
    { type:"mcq", q:"Acid uric là sản phẩm chuyển hóa của:", options:["Acid amin","Creatin","Baze purin","Tất cả các câu trên đều đúng"], correctIndex:2 },
    { type:"short", q:"Cho biết: VNT/24 giờ = 1400 ml; Creatinin/NT = 90 mg/dl; Creatinin/HT = 1,2 mg/dl → Tính Creatinin Clearance?", answers:[
      "72,9 ml/phút","72,9 ml/phut","72.9 ml/phút","72.9 ml/phut","72,9ml/phút","72.9ml/phut"
    ]}
  ];
}
function templateB(){
  return [
    { type:"mcq", q:"Có thể bảo quản nước tiểu để soi cặn lắng bằng cách thêm vào nước tiểu:", options:[
      "08 giọt formol 8% cho 300 ml nước tiểu",
      "08 giọt formol 10% cho 500 ml nước tiểu",
      "10 giọt formol 8% cho 300 ml nước tiểu",
      "10 giọt formol 10% cho 500 ml nước tiểu"
    ], correctIndex:0 },
    { type:"mcq", q:"Thuốc nhuộm Sternheimer Malbin (A và B) pha theo tỉ lệ thể tích:", options:["3 : 97","5 : 95","10 : 90","15 : 85"], correctIndex:0 },
    { type:"mcq", q:"Phản ứng Biuret dương tính với dung dịch chứa chất nào sau đây:", options:["Acid amin","Peptid","Glucose","Fructose"], correctIndex:1 },
    { type:"mcq", q:"Prolin tác dụng với ninhydrin cho màu:", options:["Xanh tím","Hồng tím","Vàng","Đỏ"], correctIndex:2 },
    { type:"mcq", q:"Vai trò muối mật là:", options:[
      "Nhũ tương hóa chất béo",
      "Giúp hấp thu Vitamin tan trong dầu",
      "Tăng hoạt tính của enzym lipaz",
      "Các ý trên đều đúng"
    ], correctIndex:3 },
    { type:"mcq", q:"Điều kiện để phản ứng xà phòng hóa xảy ra là:", options:[
      "Lipid + acid + nhiệt độ",
      "Lipid + NaOH + nhiệt độ",
      "Lipid + Ether + nhiệt độ",
      "Lipid + Alcol + nhiệt độ"
    ], correctIndex:1 },
    { type:"short", q:"Cho biết: VNT/24 giờ = 1400 ml; Nồng độ Creatinin/NT = 100 mg/dl → Tính lượng Creatinin/NT/24 giờ?", answers:[
      "1400 mg/24h","1400mg/24h","1400 mg/24 giờ","1400mg/24 giờ","1400"
    ]},
    { type:"mcq", q:"Ứng dụng của phản ứng Biuret là:", options:["Định lượng lipid","Định lượng glucose","Định lượng protein","Cả 3 ứng dụng trên"], correctIndex:2 }
  ];
}
function templateC(){
  return [
    { type:"mcq", q:"Trong kỹ thuật xét nghiệm cặn lắng nước tiểu có giai đoạn ly tâm với tốc độ:", options:[
      "1.000 vòng/phút trong 5 phút","1.500 vòng/phút trong 5 phút","2.000 vòng/phút trong 5 phút","3.000 vòng/phút trong 5 phút"
    ], correctIndex:1 },
    { type:"mcq", q:"Cách biểu thị kết quả của Hồng cầu trong cặn lắng nước tiểu là:", options:[
      "Hồng cầu: (+) - (++++) / Quang trường 10X",
      "Hồng cầu: 1 – 50 / Quang trường 10X",
      "Hồng cầu: (+) - (++++) / Quang trường 40X",
      "Hồng cầu: 1 – 50 / Quang trường 40X"
    ], correctIndex:3 },
    { type:"mcq", q:"Bệnh lý nào sau đây gây protein niệu:", options:["Viêm phổi","Viêm thận","Suy tim","Cả 3 trường hợp trên"], correctIndex:1 },
    { type:"mcq", q:"Phản ứng Ninhydrin có thể được dùng để định lượng protein:", options:["Đúng","Sai"], correctIndex:1 },
    { type:"mcq", q:"Quần áo có thể được giặt sạch bằng xà phòng, là ứng dụng của phản ứng:", options:["Hòa tan","Nhũ tương hóa","Xà phòng hóa","Tất cả đều đúng"], correctIndex:1 },
    { type:"mcq", q:"Tập hợp gồm những chất hòa tan được Lipid là:", options:[
      "Ether, NaCl, Nước cất, Alcol",
      "Ether, NaCl, Chloroform, Alcol",
      "Ether, Aceton, Chloroform, Alcol",
      "Ether, NaOH, Nước cất, Chloroform"
    ], correctIndex:2 },
    { type:"mcq", q:"Các bệnh lý sau đây làm tăng acid uric máu, CHỌN CÂU SAI:", options:[
      "Thống phong nguyên phát",
      "Suy tim",
      "Suy thận mãn",
      "Giảm hoạt tính của men Xanthin oxidase"
    ], correctIndex:3 },
    { type:"short", q:"Cho biết: VNT/24 giờ = 1400 ml; Nồng độ Creatinin/NT = 100 mg/dl → Tính lượng Creatinin/NT/24 giờ?", answers:[
      "1400 mg/24h","1400mg/24h","1400 mg/24 giờ","1400mg/24 giờ","1400"
    ]}
  ];
}

/* =========================
   TẠO 18 ĐỀ
   ========================= */
function buildExams(){
  const exams = [];
  for(let i=1;i<=18;i++){
    let qs;
    if ([1,4,7,10,13,16].includes(i)) qs = templateA();
    else if ([2,5,8,11,14,17].includes(i)) qs = templateB();
    else qs = templateC();
    exams.push({ id:i, title:`ĐỀ ${i}`, questions: qs });
  }
  return exams;
}

/* =========================
   RENDER + CHẤM
   ========================= */
let seed = Date.now(); // vào lại trang => đảo
let rnd = mulberry32(seed);
let state = { exams:[], total:0, answered:0, correct:0 };

function renderAll(){
  rnd = mulberry32(seed);
  const root = document.getElementById("root");
  root.innerHTML = "";

  const exams = buildExams().map(exam => {
    // shuffle câu trong từng đề
    const qOrder = shuffle(exam.questions.map((q, idx)=>({...q, _qid:`E${exam.id}_Q${idx+1}`})), rnd);

    // shuffle đáp án cho MCQ và cập nhật index đúng
    const renderedQs = qOrder.map(q=>{
      if (q.type !== "mcq") return {...q};
      const opts = q.options.map((t, idx)=>({t, idx}));
      const sh = shuffle(opts, rnd);
      const newCorrect = sh.findIndex(o => o.idx === q.correctIndex);
      return {...q, optionsShuffled: sh.map(o=>o.t), correctIndexShuffled: newCorrect};
    });

    return { ...exam, renderedQs };
  });

  state.exams = exams;
  state.total = exams.reduce((acc,e)=>acc+e.renderedQs.length,0);
  state.answered = 0;
  state.correct = 0;
  updateScoreBar();

  exams.forEach((exam, eIndex)=>{
    const examBox = document.createElement("section");
    examBox.className = "exam";
    examBox.dataset.exam = exam.id;

    const head = document.createElement("div");
    head.className = "examHead";
    head.innerHTML = `
      <div>
        <h2 class="examTitle">${esc(exam.title)}</h2>
        <div class="examHint">Câu trong đề và đáp án được đảo ngẫu nhiên mỗi lần vào / làm lại.</div>
      </div>
      <div class="pill">8 câu / đề</div>
    `;
    examBox.appendChild(head);

    const grid = document.createElement("div");
    grid.className = "grid";

    exam.renderedQs.forEach((q, qi)=>{
      const globalId = `${exam.id}_${qi}`; // duy nhất theo render
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.gid = globalId;
      card.dataset.exam = exam.id;
      card.dataset.type = q.type;

      const tagText = (q.type==="mcq") ? "Trắc nghiệm" : "Tự luận";
      const qhead = document.createElement("div");
      qhead.className = "qhead";
      qhead.innerHTML = `
        <p class="qtitle"><b>Câu ${qi+1}.</b> ${esc(q.q)}</p>
        <span class="tag">${tagText}</span>
      `;
      card.appendChild(qhead);

      if (q.type === "mcq"){
        const opts = document.createElement("div");
        opts.className = "options";
        const name = `radio_${exam.id}_${qi}`;

        q.optionsShuffled.forEach((t, oi)=>{
          const label = document.createElement("label");
          label.className = "opt";
          label.innerHTML = `<input type="radio" name="${name}" value="${oi}" /><div>${esc(t)}</div>`;
          label.addEventListener("click", ()=> setTimeout(()=>gradeMcq(exam.id, qi), 0));
          opts.appendChild(label);
        });

        const hint = document.createElement("div");
        hint.className = "hint";
        hint.innerHTML = `<span class="pill" id="pill_${globalId}">Chưa trả lời</span><span class="pill">Chọn 1 đáp án</span>`;

        card.appendChild(opts);
        card.appendChild(hint);
      } else {
        const row = document.createElement("div");
        row.className = "shortRow";

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Nhập đáp án...";
        input.autocomplete = "off";
        input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") gradeShort(exam.id, qi); });

        const btn = document.createElement("button");
        btn.className = "primary";
        btn.textContent = "Chấm câu này";
        btn.addEventListener("click", ()=> gradeShort(exam.id, qi));

        row.appendChild(input);
        row.appendChild(btn);

        const hint = document.createElement("div");
        hint.className = "hint";
        hint.innerHTML = `<span class="pill" id="pill_${globalId}">Chưa chấm</span><span class="pill">Enter để chấm</span>`;

        card.appendChild(row);
        card.appendChild(hint);
      }

      grid.appendChild(card);
    });

    examBox.appendChild(grid);
    root.appendChild(examBox);
  });
}

function findQuestion(examId, qIndex){
  const exam = state.exams.find(e=>e.id===examId);
  return exam?.renderedQs?.[qIndex];
}
function pillId(examId, qIndex){
  return `pill_${examId}_${qIndex}`;
}
function getPill(examId, qIndex){
  return document.getElementById(pillId(examId, qIndex));
}
function getCard(examId, qIndex){
  return document.querySelector(`.card[data-gid="${examId}_${qIndex}"]`);
}

function gradeMcq(examId, qIndex){
  const q = findQuestion(examId, qIndex);
  const card = getCard(examId, qIndex);
  const pill = getPill(examId, qIndex);
  if (!q || !card || !pill) return;

  const radios = card.querySelectorAll(`input[type="radio"]`);
  const opts = card.querySelectorAll(".opt");

  let selected = -1;
  radios.forEach((r, idx)=>{ if (r.checked) selected = idx; });

  opts.forEach(o=>o.classList.remove("correct","wrong","disabled"));

  if (selected === -1){
    pill.className="pill";
    pill.textContent="Chưa trả lời";
    recalcScore();
    return;
  }

  opts.forEach(o=>o.classList.add("disabled"));
  const ok = (selected === q.correctIndexShuffled);

  if (ok){
    opts[selected].classList.add("correct");
    pill.className="pill ok"; pill.textContent="Đúng";
  } else {
    opts[selected].classList.add("wrong");
    opts[q.correctIndexShuffled].classList.add("correct");
    pill.className="pill bad"; pill.textContent="Sai";
  }
  recalcScore();
}

function gradeShort(examId, qIndex){
  const q = findQuestion(examId, qIndex);
  const card = getCard(examId, qIndex);
  const pill = getPill(examId, qIndex);
  if (!q || !card || !pill) return;

  const input = card.querySelector(`input[type="text"]`);
  if (!input) return;

  const user = norm(input.value);
  const answers = (q.answers||[]).map(norm);

  const ok = answers.includes(user);

  input.style.borderColor = ok ? "rgba(34,197,94,.55)" : "rgba(239,68,68,.55)";
  input.style.background  = ok ? "rgba(34,197,94,.10)" : "rgba(239,68,68,.10)";

  pill.className = ok ? "pill ok" : "pill bad";
  pill.textContent = ok ? "Đúng" : "Sai";

  recalcScore();
}

function recalcScore(){
  let answered = 0, correct = 0;

  state.exams.forEach(exam=>{
    exam.renderedQs.forEach((q, qi)=>{
      const pill = getPill(exam.id, qi);
      const st = pill?.textContent || "";
      if (st==="Đúng" || st==="Sai"){
        answered++;
        if (st==="Đúng") correct++;
      }
    });
  });

  state.answered = answered;
  state.correct = correct;
  updateScoreBar();
}

function updateScoreBar(){
  const bar = document.getElementById("scoreBar");
  bar.innerHTML = `
    <span class="pill">Tổng câu: <b style="color:var(--text)">${state.total}</b></span>
    <span class="pill">Đã chấm: <b style="color:var(--text)">${state.answered}</b></span>
    <span class="pill ok">Đúng: <b>${state.correct}</b></span>
    <span class="pill bad">Sai: <b>${Math.max(0, state.answered - state.correct)}</b></span>
  `;
}

/* =========================
   NÚT ĐIỀU KHIỂN
   ========================= */
function checkAll(){
  state.exams.forEach(exam=>{
    exam.renderedQs.forEach((q, qi)=>{
      if (q.type==="mcq") gradeMcq(exam.id, qi);
      else gradeShort(exam.id, qi);
    });
  });
}
function clearAll(){
  state.exams.forEach(exam=>{
    exam.renderedQs.forEach((q, qi)=>{
      const card = getCard(exam.id, qi);
      const pill = getPill(exam.id, qi);
      if (!card || !pill) return;

      pill.className = "pill";
      pill.textContent = (q.type==="mcq") ? "Chưa trả lời" : "Chưa chấm";

      if (q.type==="mcq"){
        card.querySelectorAll(`input[type="radio"]`).forEach(r=>r.checked=false);
        card.querySelectorAll(".opt").forEach(o=>o.classList.remove("correct","wrong","disabled"));
      } else {
        const input = card.querySelector(`input[type="text"]`);
        if (input){
          input.value = "";
          input.style.borderColor = "rgba(255,255,255,.12)";
          input.style.background  = "rgba(0,0,0,.16)";
        }
      }
    });
  });
  state.answered = 0;
  state.correct = 0;
  updateScoreBar();
}
function resetShuffle(){
  seed = Date.now(); // seed mới => đảo
  renderAll();
}

/* =========================
   INIT
   ========================= */
document.getElementById("btnCheckAll").addEventListener("click", checkAll);
document.getElementById("btnClear").addEventListener("click", clearAll);
document.getElementById("btnReset").addEventListener("click", resetShuffle);

renderAll();
</script>
</body>
</html>
